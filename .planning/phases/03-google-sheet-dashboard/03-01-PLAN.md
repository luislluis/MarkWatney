---
phase: 03-google-sheet-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sheets_dashboard.py
autonomous: true
user_setup:
  - service: google-sheets
    why: "Dashboard spreadsheet for performance tracker"
    env_vars:
      - name: PERF_TRACKER_SPREADSHEET_ID
        source: "Copy spreadsheet ID from URL after creation, or leave empty for auto-create"
    dashboard_config:
      - task: "Share sheet with your email"
        location: "Automatic - service account shares with SHARE_WITH_EMAIL env var"

must_haves:
  truths:
    - "Dashboard module connects to Google Sheets"
    - "Headers and summary row created on first run"
    - "Module provides log_dashboard_row() function"
  artifacts:
    - path: "sheets_dashboard.py"
      provides: "Dashboard Google Sheets module"
      exports: ["DashboardLogger", "init_dashboard", "log_dashboard_row"]
      min_lines: 150
  key_links:
    - from: "sheets_dashboard.py"
      to: "gspread"
      via: "service account authentication"
      pattern: "gspread\\.service_account"
---

<objective>
Create the Google Sheets dashboard module with sheet structure and connection logic.

Purpose: Provide the foundation for logging window results to a dedicated performance dashboard.
Output: `sheets_dashboard.py` module with sheet setup and row logging capability.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-google-sheet-dashboard/03-RESEARCH.md

# Reference for gspread patterns
@sheets_logger.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sheets_dashboard.py with connection and sheet setup</name>
  <files>sheets_dashboard.py</files>
  <action>
Create `sheets_dashboard.py` with:

1. **Color constants** (0-1 RGB scale for Google Sheets API):
   - GREEN_BG = {"red": 0.85, "green": 0.92, "blue": 0.83}
   - RED_BG = {"red": 0.96, "green": 0.80, "blue": 0.80}
   - GRAY_BG = {"red": 0.95, "green": 0.95, "blue": 0.95}

2. **Headers constant**:
   HEADERS = ['Window', 'Time', 'ARB Entry', 'ARB Result', 'ARB P/L',
              '99c Entry', '99c Result', '99c P/L', 'Total P/L']

3. **DashboardLogger class** with:
   - `__init__()`: Initialize state (spreadsheet=None, worksheet=None, _initialized=False)
   - `_ensure_initialized()`: Lazy initialization pattern (from sheets_logger.py)
     - Load credentials from `GOOGLE_SHEETS_CREDENTIALS_FILE` env var (default: ~/.google_sheets_credentials.json)
     - Check `PERF_TRACKER_SPREADSHEET_ID` env var:
       - If set: Open existing spreadsheet by ID
       - If not set: Create new spreadsheet named "Performance Tracker Dashboard"
     - After create: Share with `SHARE_WITH_EMAIL` env var if set (so user can see it)
     - Get or create worksheet named "Dashboard"
     - If worksheet is new (no data), set up structure:
       - Row 1: Headers (frozen, bold)
       - Row 2: Initial summary row ['SUMMARY', '-', '-', '-', '$0.00', '-', '-', '$0.00', '$0.00']
       - Freeze rows 1-2
     - Return True on success, False on error

4. **Error handling**: Use same retry pattern as sheets_logger.py (3 retries with exponential backoff)

5. **Module-level convenience functions**:
   - `init_dashboard()` -> DashboardLogger (initialize global instance)
   - `get_dashboard()` -> Optional[DashboardLogger] (get global instance)
  </action>
  <verify>
```bash
python3 -c "from sheets_dashboard import DashboardLogger, init_dashboard; print('Import OK')"
```
  </verify>
  <done>sheets_dashboard.py exists with DashboardLogger class, color constants, headers, and _ensure_initialized() method that creates/opens spreadsheet and sets up sheet structure</done>
</task>

<task type="auto">
  <name>Task 2: Add log_dashboard_row() function with emoji indicators</name>
  <files>sheets_dashboard.py</files>
  <action>
Add to `sheets_dashboard.py`:

1. **Emoji constants**:
   - EMOJI_WIN = "✓"
   - EMOJI_LOSS = "✗"
   - EMOJI_WARN = "⚠"
   - EMOJI_NONE = "—"

2. **Helper function format_result_with_emoji(result)**:
   - 'PAIRED', 'WIN' -> f"{EMOJI_WIN} {result}"
   - 'BAIL', 'LOPSIDED', 'LOSS' -> f"{EMOJI_LOSS} {result}"
   - None or '-' -> EMOJI_NONE
   - Other -> result as-is

3. **DashboardLogger.log_row(window_state)** method:
   - Extract from window_state dict:
     - slug, arb_entry, arb_result, arb_pnl, capture_entry, capture_result, capture_pnl
   - Parse window time from slug (e.g., btc-updown-15m-1737417600 -> 14:00)
   - Build row values:
     - Window: slug (truncated to last component for readability)
     - Time: parsed time in HH:MM format
     - ARB Entry: 'Yes' if arb_entry else EMOJI_NONE
     - ARB Result: format_result_with_emoji(arb_result)
     - ARB P/L: f'${arb_pnl:+.2f}' if arb_entry else EMOJI_NONE
     - 99c Entry: 'Yes' if capture_entry else EMOJI_NONE
     - 99c Result: format_result_with_emoji(capture_result)
     - 99c P/L: f'${capture_pnl:+.2f}' if capture_entry else EMOJI_NONE
     - Total P/L: f'${(arb_pnl + capture_pnl):+.2f}'
   - Append row to worksheet via worksheet.append_row(row_data, value_input_option='USER_ENTERED')
   - Return row number that was written (for formatting in next plan)

4. **Module-level convenience function**:
   - `log_dashboard_row(window_state)` -> bool (logs row via global instance)
  </action>
  <verify>
```bash
python3 -c "
from sheets_dashboard import format_result_with_emoji, EMOJI_WIN, EMOJI_LOSS
assert format_result_with_emoji('PAIRED') == '✓ PAIRED'
assert format_result_with_emoji('LOSS') == '✗ LOSS'
print('Emoji formatting OK')
"
```
  </verify>
  <done>log_dashboard_row() function exists that takes window_state dict and writes a formatted row with emoji indicators to the Dashboard sheet</done>
</task>

</tasks>

<verification>
1. `python3 -c "import sheets_dashboard; print(sheets_dashboard.HEADERS)"` shows column headers
2. `python3 -c "from sheets_dashboard import format_result_with_emoji; print(format_result_with_emoji('WIN'))"` shows "✓ WIN"
3. Module imports without errors
</verification>

<success_criteria>
- sheets_dashboard.py exists with 150+ lines
- DashboardLogger class with _ensure_initialized() and log_row() methods
- Color constants defined (GREEN_BG, RED_BG, GRAY_BG)
- Emoji constants and format_result_with_emoji() helper
- Module-level init_dashboard() and log_dashboard_row() convenience functions
</success_criteria>

<output>
After completion, create `.planning/phases/03-google-sheet-dashboard/03-01-SUMMARY.md`
</output>
