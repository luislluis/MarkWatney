---
phase: 03-google-sheet-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - sheets_dashboard.py
  - performance_tracker.py
autonomous: true

must_haves:
  truths:
    - "Green cells appear for wins/profits"
    - "Red cells appear for losses"
    - "Summary row shows running totals and win rates"
    - "Window rows are written to Google Sheet on window close"
  artifacts:
    - path: "sheets_dashboard.py"
      provides: "Color formatting and summary update"
      exports: ["apply_row_formatting", "update_summary_row"]
    - path: "performance_tracker.py"
      provides: "Integration with dashboard module"
      contains: "from sheets_dashboard import"
  key_links:
    - from: "performance_tracker.py"
      to: "sheets_dashboard.py"
      via: "log_dashboard_row call in grade_window"
      pattern: "log_dashboard_row\\(window_state\\)"
    - from: "sheets_dashboard.py"
      to: "Google Sheets API"
      via: "batch_format for colors"
      pattern: "batch_format"
---

<objective>
Add color formatting and summary row updates, then wire dashboard into performance tracker.

Purpose: Complete the beautiful dashboard with green/red color coding and running totals.
Output: Fully functional dashboard integration that logs each window with colors and updates summary.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-google-sheet-dashboard/03-RESEARCH.md
@.planning/phases/03-google-sheet-dashboard/03-01-SUMMARY.md

# Files to modify
@sheets_dashboard.py
@performance_tracker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add color formatting to log_row()</name>
  <files>sheets_dashboard.py</files>
  <action>
Modify `sheets_dashboard.py` to add cell coloring after row write:

1. **Update log_row()** to apply formatting after appending:
   - After worksheet.append_row(), get row number: `last_row = len(worksheet.get_all_values())`
   - Build formats list based on values:

   ```python
   formats = []

   # ARB Result column (D) - green for PAIRED, red for BAIL/LOPSIDED
   if arb_result == 'PAIRED':
       formats.append({"range": f"D{last_row}", "format": {"backgroundColor": GREEN_BG}})
   elif arb_result in ('BAIL', 'LOPSIDED'):
       formats.append({"range": f"D{last_row}", "format": {"backgroundColor": RED_BG}})

   # ARB P/L column (E) - green if positive, red if negative
   if arb_pnl > 0:
       formats.append({"range": f"E{last_row}", "format": {"backgroundColor": GREEN_BG}})
   elif arb_pnl < 0:
       formats.append({"range": f"E{last_row}", "format": {"backgroundColor": RED_BG}})

   # 99c Result column (G) - green for WIN, red for LOSS
   if capture_result == 'WIN':
       formats.append({"range": f"G{last_row}", "format": {"backgroundColor": GREEN_BG}})
   elif capture_result == 'LOSS':
       formats.append({"range": f"G{last_row}", "format": {"backgroundColor": RED_BG}})

   # 99c P/L column (H) - green if positive, red if negative
   if capture_pnl > 0:
       formats.append({"range": f"H{last_row}", "format": {"backgroundColor": GREEN_BG}})
   elif capture_pnl < 0:
       formats.append({"range": f"H{last_row}", "format": {"backgroundColor": RED_BG}})

   # Total P/L column (I) - green if positive, red if negative
   total_pnl = arb_pnl + capture_pnl
   if total_pnl > 0:
       formats.append({"range": f"I{last_row}", "format": {"backgroundColor": GREEN_BG}})
   elif total_pnl < 0:
       formats.append({"range": f"I{last_row}", "format": {"backgroundColor": RED_BG}})

   # Apply all formats in one batch call
   if formats:
       worksheet.batch_format(formats)
   ```

2. **Error handling**: Wrap formatting in try/except (graceful degradation if formatting fails)
  </action>
  <verify>
```bash
python3 -c "from sheets_dashboard import GREEN_BG, RED_BG; print('Color constants:', GREEN_BG, RED_BG)"
```
  </verify>
  <done>log_row() applies green/red cell coloring based on results and P/L values using batch_format()</done>
</task>

<task type="auto">
  <name>Task 2: Add summary row update function</name>
  <files>sheets_dashboard.py</files>
  <action>
Add to `sheets_dashboard.py`:

1. **Helper function parse_pnl(pnl_str)**:
   - Handle formats: '$+0.05', '$-0.10', '-', '—'
   - Return float (0.0 for non-numeric)

2. **DashboardLogger.update_summary()** method:
   - Get all values: `all_values = worksheet.get_all_values()`
   - Skip header (row 0) and summary (row 1), process data rows (row 2+)
   - data_rows = all_values[2:]

   - Calculate totals:
     - total_arb_pnl = sum(parse_pnl(row[4]) for row in data_rows)  # Column E
     - total_99c_pnl = sum(parse_pnl(row[7]) for row in data_rows)  # Column H
     - total_pnl = total_arb_pnl + total_99c_pnl

   - Calculate win rates:
     - arb_wins = count rows where row[3] contains '✓' (PAIRED)
     - arb_trades = count rows where row[2] == 'Yes'
     - arb_rate = f"{arb_wins}/{arb_trades}" if arb_trades else "-"
     - capture_wins = count rows where row[6] contains '✓' (WIN)
     - capture_trades = count rows where row[5] == 'Yes'
     - capture_rate = f"{capture_wins}/{capture_trades}" if capture_trades else "-"

   - Build summary row:
     ```python
     summary = [
         'SUMMARY',
         '-',                                  # Time (not applicable)
         arb_rate,                             # ARB Entry shows win rate
         '-',                                  # ARB Result
         f'${total_arb_pnl:+.2f}',            # ARB P/L total
         capture_rate,                         # 99c Entry shows win rate
         '-',                                  # 99c Result
         f'${total_99c_pnl:+.2f}',            # 99c P/L total
         f'${total_pnl:+.2f}'                 # Total P/L
     ]
     ```

   - Update row 2 in place: `worksheet.update('A2:I2', [summary], value_input_option='USER_ENTERED')`

   - Apply coloring to summary P/L cells (E2, H2, I2) based on positive/negative

3. **Update log_row()** to call update_summary() after writing data row

4. **Module-level convenience function**:
   - `update_dashboard_summary()` -> bool
  </action>
  <verify>
```bash
python3 -c "from sheets_dashboard import parse_pnl; assert parse_pnl('\$+0.05') == 0.05; assert parse_pnl('\$-0.10') == -0.10; print('parse_pnl OK')"
```
  </verify>
  <done>update_summary() calculates running totals and win rates, updates row 2 in place with colors</done>
</task>

<task type="auto">
  <name>Task 3: Wire dashboard into performance_tracker.py</name>
  <files>performance_tracker.py</files>
  <action>
Modify `performance_tracker.py` to use the dashboard module:

1. **Add import at top** (after other imports):
   ```python
   from sheets_dashboard import init_dashboard, log_dashboard_row
   ```

2. **Initialize dashboard in main()** after startup banner:
   ```python
   # Initialize Google Sheets dashboard
   dashboard = init_dashboard()
   if dashboard and dashboard.enabled:
       print(f"[DASHBOARD] Connected to Google Sheets")
   else:
       print(f"[DASHBOARD] Disabled - will log to console only")
   ```

3. **Update grade_window()** to log to dashboard:
   - After printing the console output, add:
     ```python
     # Log to Google Sheets dashboard
     log_dashboard_row(state)
     ```

4. **Handle graceful degradation**: If dashboard not enabled, just log to console (existing behavior)
  </action>
  <verify>
```bash
python3 -c "import performance_tracker; print('Import OK')"
```
  </verify>
  <done>performance_tracker.py imports and uses sheets_dashboard module, calling log_dashboard_row() in grade_window()</done>
</task>

</tasks>

<verification>
1. `grep -n "log_dashboard_row" performance_tracker.py` shows integration in grade_window()
2. `grep -n "batch_format" sheets_dashboard.py` shows color formatting
3. `grep -n "update_summary" sheets_dashboard.py` shows summary update function
4. `python3 -c "import performance_tracker"` imports without errors
</verification>

<success_criteria>
- Color formatting applies to result and P/L columns (green for wins/positive, red for losses/negative)
- Summary row at row 2 updates with running totals and win rates
- performance_tracker.py calls log_dashboard_row() in grade_window()
- Both console logging and sheet logging work (graceful degradation if sheets unavailable)
</success_criteria>

<output>
After completion, create `.planning/phases/03-google-sheet-dashboard/03-02-SUMMARY.md`
</output>
