---
phase: 01-tracking-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [trading_bot_smart.py]
autonomous: true

must_haves:
  truths:
    - "VELOCITY_WINDOW_SECONDS constant exists and equals 5"
    - "btc_price_history deque exists at module level with maxlen=5"
    - "window_state contains danger_score field initialized to 0"
    - "window_state contains capture_99c_peak_confidence field initialized to 0"
    - "BTC price is appended to btc_price_history every second when available"
    - "Peak confidence is recorded at 99c capture fill detection time"
  artifacts:
    - path: "trading_bot_smart.py"
      provides: "Tracking infrastructure for danger score system"
      contains: "VELOCITY_WINDOW_SECONDS"
  key_links:
    - from: "btc_price_history"
      to: "log_state()"
      via: "append after btc_price fetch"
      pattern: "btc_price_history\\.append"
    - from: "capture_99c_peak_confidence"
      to: "fill detection block"
      via: "assignment at fill time"
      pattern: "capture_99c_peak_confidence.*=.*calculate_99c_confidence"
---

<objective>
Add tracking infrastructure for the danger score system.

Purpose: Enable future danger score calculation by tracking peak confidence at 99c fill and maintaining rolling BTC price history for velocity calculation.

Output: Modified trading_bot_smart.py with new constants, state fields, and tracking logic.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-tracking-infrastructure/01-RESEARCH.md
@trading_bot_smart.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add constants and state infrastructure</name>
  <files>trading_bot_smart.py</files>
  <action>
Add tracking infrastructure in three locations:

1. **Add VELOCITY_WINDOW_SECONDS constant** (after line 281, after CAPTURE_99C_TIME_PENALTIES):
   ```python
   # Velocity tracking for danger score
   VELOCITY_WINDOW_SECONDS = 5  # Rolling window for BTC price velocity
   ```

2. **Add btc_price_history deque** (after line 300, after api_latencies):
   ```python
   # Rolling window for BTC price velocity (danger score calculation)
   btc_price_history = deque(maxlen=VELOCITY_WINDOW_SECONDS)
   ```
   Note: This is global state, NOT in reset_window_state() - it must persist across windows.

3. **Add fields to reset_window_state()** (after line 380, after pending_hedge_side):
   ```python
   "danger_score": 0,                    # Current danger score (0.0-1.0)
   "capture_99c_peak_confidence": 0,     # Confidence at 99c fill time
   ```

Preserve existing code structure and formatting. Do NOT modify any other constants or state fields.
  </action>
  <verify>
Run: `grep -n "VELOCITY_WINDOW_SECONDS\|btc_price_history\|danger_score\|capture_99c_peak_confidence" trading_bot_smart.py`
Should show all 4 new additions at appropriate line numbers.
  </verify>
  <done>
- VELOCITY_WINDOW_SECONDS = 5 exists in constants section
- btc_price_history = deque(maxlen=VELOCITY_WINDOW_SECONDS) exists in global state section
- "danger_score": 0 exists in reset_window_state() return dict
- "capture_99c_peak_confidence": 0 exists in reset_window_state() return dict
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tracking logic for price history and peak confidence</name>
  <files>trading_bot_smart.py</files>
  <action>
Add tracking logic in two locations:

1. **Append BTC price to rolling window** (in log_state(), after line 762 where btc_price is set):
   After the line `btc_str = f"BTC:${btc_price:,.0f}({btc_age}s) | "`, add:
   ```python
   btc_price_history.append((time.time(), btc_price))
   ```
   This goes INSIDE the `if btc_price:` block.

2. **Record peak confidence at fill time** (in main loop ~line 2372, BEFORE setting capture_99c_fill_notified):
   After the fill celebration print statements and BEFORE `window_state['capture_99c_fill_notified'] = True`, add:
   ```python
   # Record peak confidence at fill time
   current_ask = ask_up if side == "UP" else ask_down
   peak_conf, _ = calculate_99c_confidence(current_ask, remaining_secs)
   window_state['capture_99c_peak_confidence'] = peak_conf
   ```
   Note: `ask_up` and `ask_down` are available from `books` in the enclosing scope. You need to get them from `books`:
   ```python
   # Record peak confidence at fill time
   if books.get('up_asks') and books.get('down_asks'):
       current_ask = float(books['up_asks'][0]['price']) if side == "UP" else float(books['down_asks'][0]['price'])
       peak_conf, _ = calculate_99c_confidence(current_ask, remaining_secs)
       window_state['capture_99c_peak_confidence'] = peak_conf
   ```

Do NOT modify any other logic. Preserve existing indentation and code structure.
  </action>
  <verify>
Run: `grep -n "btc_price_history.append\|capture_99c_peak_confidence.*=" trading_bot_smart.py`
Should show:
- btc_price_history.append in log_state() function
- capture_99c_peak_confidence assignment in main loop fill detection block
  </verify>
  <done>
- BTC price is appended to btc_price_history inside log_state() when btc_price is not None
- Peak confidence is calculated and stored at 99c capture fill detection time
- Peak confidence uses current ask price and remaining_secs (not order placement values)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Syntax check:
   ```bash
   python3 -m py_compile trading_bot_smart.py
   ```

2. Verify all additions exist:
   ```bash
   grep -n "VELOCITY_WINDOW_SECONDS" trading_bot_smart.py
   grep -n "btc_price_history" trading_bot_smart.py
   grep -n "danger_score" trading_bot_smart.py
   grep -n "capture_99c_peak_confidence" trading_bot_smart.py
   ```

3. Verify deque is at module level (not in reset_window_state):
   ```bash
   grep -B2 "btc_price_history = deque" trading_bot_smart.py
   ```
   Should show it near other global state, NOT inside a function.
</verification>

<success_criteria>
Phase 1 requirements satisfied:
- [TRACK-01] Peak confidence tracked: capture_99c_peak_confidence recorded at fill time
- [TRACK-02] Rolling price window: btc_price_history deque appended every second
- [TRACK-03] Danger score field: danger_score in window_state (initialized to 0)
- [CFG-03] Configurable window: VELOCITY_WINDOW_SECONDS constant (default 5)

Bot compiles without syntax errors.
</success_criteria>

<output>
After completion, create `.planning/phases/01-tracking-infrastructure/01-01-SUMMARY.md`
</output>
