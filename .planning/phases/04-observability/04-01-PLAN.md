---
phase: 04-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sheets_logger.py
  - trading_bot_smart.py
autonomous: true

must_haves:
  truths:
    - "Google Sheets Ticks tab has Danger column with danger score values when 99c position held"
    - "Hedge events in Events tab include all 5 signal components (conf, imb, vel, opp, time)"
    - "Console output shows D:X.XX indicator when holding 99c position"
  artifacts:
    - path: "sheets_logger.py"
      provides: "Danger column in TICKS_HEADERS, danger_score parameter in buffer_tick"
      contains: "Danger"
    - path: "trading_bot_smart.py"
      provides: "danger_result storage, enhanced logging, console display"
      contains: "danger_result"
  key_links:
    - from: "trading_bot_smart.py log_state()"
      to: "sheets_logger.py buffer_tick()"
      via: "danger_score parameter"
      pattern: "danger_score=danger_for_log"
    - from: "trading_bot_smart.py check_99c_capture_hedge()"
      to: "sheets_log_event()"
      via: "signal breakdown kwargs"
      pattern: "conf_drop=|imb_raw=|vel_raw="
---

<objective>
Add observability for the danger scoring system: danger score column in Google Sheets Ticks, full signal breakdown in hedge event logs, and console display of danger score when holding 99c position.

Purpose: Enable post-mortem analysis of danger scores and hedge decisions for threshold tuning.
Output: Updated sheets_logger.py and trading_bot_smart.py with observability features, version bumped to v1.7.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-observability/04-RESEARCH.md

# Prior phase context
@.planning/phases/02-danger-scoring-engine/02-01-SUMMARY.md (provides calculate_danger_score return structure)
@.planning/phases/03-hedge-execution/03-01-SUMMARY.md (provides current hedge logging)

# Source files
@sheets_logger.py (lines 72-85 TICKS_HEADERS, 309-330 buffer_tick, 340-356 flush_ticks row, 423-434 helper)
@trading_bot_smart.py (lines 720-808 log_state, 1323-1399 check_99c_capture_hedge, 2517-2526 danger_result)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add danger_score column to sheets_logger.py</name>
  <files>sheets_logger.py</files>
  <action>
  Update sheets_logger.py to add danger_score support:

  1. **TICKS_HEADERS (line 72-85):** Add "Danger" column before "Reason":
     ```python
     TICKS_HEADERS = [
         "Timestamp",
         "Window ID",
         "TTL",
         "Status",
         "UP Ask",
         "DN Ask",
         "UP Pos",
         "DN Pos",
         "BTC",
         "UP Imb",
         "DN Imb",
         "Danger",  # NEW
         "Reason"
     ]
     ```

  2. **buffer_tick method (line 309-330):** Add danger_score parameter:
     ```python
     def buffer_tick(self, window_id: str, ttc: float, status: str,
                     ask_up: float, ask_down: float, up_shares: float, down_shares: float,
                     btc_price: float = None, up_imb: float = None, down_imb: float = None,
                     danger_score: float = None,  # NEW parameter
                     reason: str = "") -> None:
     ```
     Add to the dictionary:
     ```python
     "danger_score": danger_score,  # NEW field
     ```

  3. **flush_ticks row construction (line 340-356):** Add danger_score formatting before reason:
     ```python
     f"{t['danger_score']:.2f}" if t["danger_score"] is not None else "",  # NEW
     ```

  4. **buffer_tick helper function (line 423-434):** Add danger_score parameter to match:
     ```python
     def buffer_tick(window_id: str, ttc: float, status: str,
                     ask_up: float, ask_down: float, up_shares: float, down_shares: float,
                     btc_price: float = None, up_imb: float = None, down_imb: float = None,
                     danger_score: float = None,  # NEW parameter
                     reason: str = "") -> None:
     ```
     Pass to _logger.buffer_tick:
     ```python
     _logger.buffer_tick(window_id, ttc, status, ask_up, ask_down, up_shares, down_shares,
                         btc_price, up_imb, down_imb, danger_score, reason)  # NEW arg
     ```
  </action>
  <verify>grep -n "Danger" sheets_logger.py | head -5 (should show Danger in TICKS_HEADERS); grep -n "danger_score" sheets_logger.py | wc -l (should be 5+ occurrences)</verify>
  <done>TICKS_HEADERS has 13 columns with "Danger" before "Reason"; buffer_tick method, flush_ticks, and helper all handle danger_score parameter</done>
</task>

<task type="auto">
  <name>Task 2: Update trading_bot_smart.py with danger observability</name>
  <files>trading_bot_smart.py</files>
  <action>
  Update trading_bot_smart.py for LOG-01, LOG-02, LOG-03:

  1. **Store danger_result (around line 2526):** After calculating danger_result, store the full dict:
     ```python
     window_state['danger_score'] = danger_result['score']
     window_state['danger_result'] = danger_result  # NEW - store full result for logging
     ```

  2. **LOG-03: Console display (log_state around line 799-800):** Add danger score indicator before printing:
     ```python
     # Build danger score indicator if applicable (LOG-03)
     danger_str = ""
     if window_state.get('capture_99c_fill_notified') and not window_state.get('capture_99c_hedged'):
         ds = window_state.get('danger_score', 0)
         danger_str = f" | D:{ds:.2f}"

     price_str = f"UP:{ask_up*100:2.0f}c DN:{ask_down*100:2.0f}c"
     print(f"[{ts()}] {status:7} | T-{ttc:3.0f}s | {btc_str}{price_str}{ob_str}{danger_str} | pos:{up_shares:.0f}/{down_shares:.0f} | {reason}")
     ```

  3. **LOG-01: Pass danger_score to buffer_tick (around line 803-807):** Get danger score if applicable and pass to buffer_tick:
     ```python
     # Get danger score if holding 99c position (LOG-01)
     danger_for_log = None
     if window_state.get('capture_99c_fill_notified') and not window_state.get('capture_99c_hedged'):
         danger_for_log = window_state.get('danger_score')

     # Buffer tick for Google Sheets (batched upload)
     buffer_tick(
         window_state.get('window_id', ''),
         ttc, status, ask_up, ask_down, up_shares, down_shares,
         btc_price=btc_price, up_imb=up_imb, down_imb=down_imb,
         danger_score=danger_for_log,  # NEW parameter
         reason=reason
     )
     ```

  4. **LOG-02: Enhanced hedge event logging (check_99c_capture_hedge around line 1392-1395):** Replace sheets_log_event call with full signal breakdown:
     ```python
     danger_result = window_state.get('danger_result', {})
     sheets_log_event("99C_HEDGE", window_state.get('window_id', ''),
                    bet_side=bet_side, hedge_side=opposite_side,
                    hedge_price=opposite_ask, combined=combined, loss=total_loss,
                    danger_score=danger_score,
                    # LOG-02: Signal breakdown - all 5 raw values and weighted components
                    conf_drop=danger_result.get('confidence_drop', 0),
                    conf_wgt=danger_result.get('confidence_component', 0),
                    imb_raw=danger_result.get('imbalance', 0),
                    imb_wgt=danger_result.get('imbalance_component', 0),
                    vel_raw=danger_result.get('velocity', 0),
                    vel_wgt=danger_result.get('velocity_component', 0),
                    opp_raw=danger_result.get('opponent_ask', 0),
                    opp_wgt=danger_result.get('opponent_component', 0),
                    time_raw=danger_result.get('time_remaining', 0),
                    time_wgt=danger_result.get('time_component', 0))
     ```
  </action>
  <verify>grep -n "danger_result\|danger_for_log\|danger_str" trading_bot_smart.py | wc -l (should be 6+ occurrences); grep "D:{ds:" trading_bot_smart.py (should match console format); grep "conf_drop=\|imb_raw=" trading_bot_smart.py (should match hedge event logging)</verify>
  <done>log_state shows D:X.XX when holding 99c; buffer_tick receives danger_score; hedge event logs all 5 signal components; danger_result stored in window_state</done>
</task>

<task type="auto">
  <name>Task 3: Bump version and commit</name>
  <files>trading_bot_smart.py</files>
  <action>
  Update BOT_VERSION at top of trading_bot_smart.py (around line 1-30):
  ```python
  BOT_VERSION = {
      "version": "v1.7",
      "codename": "Watchful Owl",
      "date": "2026-01-19",
      "changes": "Observability: danger score in Ticks, signal breakdown in hedge events, console D:X.XX display"
  }
  ```

  Commit all changes:
  ```bash
  git add sheets_logger.py trading_bot_smart.py
  git commit -m "feat(04-01): add danger score observability (LOG-01, LOG-02, LOG-03)

  - Add Danger column to Google Sheets Ticks (LOG-01)
  - Log 5-signal breakdown on hedge events (LOG-02)
  - Display D:X.XX in console when holding 99c position (LOG-03)
  - Bump version to v1.7 Watchful Owl

  Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
  ```
  </action>
  <verify>grep -A4 "BOT_VERSION" trading_bot_smart.py | head -6 (should show v1.7, Watchful Owl); git log -1 --oneline (should show feat(04-01) commit)</verify>
  <done>BOT_VERSION shows v1.7 "Watchful Owl"; all observability changes committed</done>
</task>

</tasks>

<verification>
After all tasks:
1. `grep "Danger" sheets_logger.py` - Shows Danger in TICKS_HEADERS
2. `grep -c "danger_score" sheets_logger.py` - Returns 5+ (parameter propagated through all functions)
3. `grep "D:{ds:" trading_bot_smart.py` - Shows console format
4. `grep "conf_drop=\|conf_wgt=" trading_bot_smart.py` - Shows signal breakdown in hedge event
5. `grep -A4 "BOT_VERSION" trading_bot_smart.py` - Shows v1.7 Watchful Owl
6. `python3 -c "import sheets_logger; print(len(sheets_logger.TICKS_HEADERS))"` - Returns 13
</verification>

<success_criteria>
- LOG-01: TICKS_HEADERS has 13 columns including "Danger"; danger_score flows from log_state to buffer_tick to flush_ticks
- LOG-02: 99C_HEDGE event logs include conf_drop, conf_wgt, imb_raw, imb_wgt, vel_raw, vel_wgt, opp_raw, opp_wgt, time_raw, time_wgt
- LOG-03: Console prints "D:X.XX" when capture_99c_fill_notified=True and capture_99c_hedged=False
- Version v1.7 "Watchful Owl" committed
</success_criteria>

<output>
After completion, create `.planning/phases/04-observability/04-01-SUMMARY.md`
</output>
