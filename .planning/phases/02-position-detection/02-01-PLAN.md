---
phase: 02-position-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [performance_tracker.py]
autonomous: true

must_haves:
  truths:
    - "Bot detects when wallet has UP positions in current window"
    - "Bot detects when wallet has DOWN positions in current window"
    - "Bot identifies ARB trades (both UP and DOWN positions)"
    - "Bot identifies 99c capture trades (single-side position)"
  artifacts:
    - path: "performance_tracker.py"
      provides: "Position fetching and trade type detection"
      exports: ["get_token_ids", "fetch_positions", "detect_trade_type"]
  key_links:
    - from: "performance_tracker.py"
      to: "data-api.polymarket.com"
      via: "HTTP GET in fetch_positions"
      pattern: "data-api\\.polymarket\\.com/positions"
    - from: "performance_tracker.py:main()"
      to: "window_state"
      via: "position polling updates state"
      pattern: "window_state.*=.*detect"
---

<objective>
Add position fetching and trade type detection to the performance tracker.

Purpose: Enable the bot to detect what trades the trading bot made each window (ARB vs 99c capture).
Output: Bot polls positions each second and identifies trade types in real-time.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-position-detection/02-RESEARCH.md
@performance_tracker.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add position fetching functions</name>
  <files>performance_tracker.py</files>
  <action>
Add two functions to performance_tracker.py based on the patterns in 02-RESEARCH.md:

1. `get_token_ids(market)`:
   - Extract UP and DOWN token IDs from market data
   - Parse `market.get('markets', [{}])[0].get('clobTokenIds', '')`
   - Handle bracket/quote removal, split by comma
   - Return `(up_token, down_token)` tuple or `(None, None)` on error
   - Pattern from research lines 121-131

2. `fetch_positions(wallet_address, up_token, down_token)`:
   - Call `https://data-api.polymarket.com/positions?user={wallet.lower()}`
   - Use existing `http_session` with 5-second timeout
   - Loop through positions, match by `asset` field
   - Return `(up_shares, down_shares)` as floats
   - Return `(0, 0)` on any error
   - Pattern from research lines 95-118

Add these after the window detection functions section, before the state management section.
  </action>
  <verify>
Run: `python3 -c "import performance_tracker; print(performance_tracker.get_token_ids.__doc__)"` should show docstring.
Run: `python3 -c "import performance_tracker; print(performance_tracker.fetch_positions.__doc__)"` should show docstring.
  </verify>
  <done>
Both functions exist and are importable. get_token_ids parses market data correctly. fetch_positions calls position API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add trade type detection</name>
  <files>performance_tracker.py</files>
  <action>
Add `detect_trade_type(up_shares, down_shares)` function:

- If both `up_shares == 0` and `down_shares == 0`: return `'NO_TRADE'`
- If both `up_shares > 0` and `down_shares > 0`: return `'ARB'`
- Otherwise (single side has shares): return `'99C_CAPTURE'`

Pattern from research lines 135-154.

This function is purely logic, no API calls.
  </action>
  <verify>
Run: `python3 -c "from performance_tracker import detect_trade_type; print(detect_trade_type(5, 5))"` should print `ARB`.
Run: `python3 -c "from performance_tracker import detect_trade_type; print(detect_trade_type(5, 0))"` should print `99C_CAPTURE`.
Run: `python3 -c "from performance_tracker import detect_trade_type; print(detect_trade_type(0, 0))"` should print `NO_TRADE`.
  </verify>
  <done>
detect_trade_type correctly classifies all three cases: NO_TRADE, ARB, 99C_CAPTURE.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate position polling into main loop</name>
  <files>performance_tracker.py</files>
  <action>
Modify main() to poll positions and update window_state:

1. After `cached_market` is fetched and valid, extract token IDs:
   ```python
   up_token, down_token = get_token_ids(cached_market)
   ```
   Store these in window_state or as local variables.

2. In the main loop (after time remaining check, before status line), add position polling:
   ```python
   if up_token and down_token and WALLET_ADDRESS:
       up_shares, down_shares = fetch_positions(WALLET_ADDRESS, up_token, down_token)
       trade_type = detect_trade_type(up_shares, down_shares)

       # Update window_state with position data
       if trade_type == 'ARB':
           window_state['arb_entry'] = {'up_shares': up_shares, 'down_shares': down_shares}
       elif trade_type == '99C_CAPTURE':
           side = 'UP' if up_shares > 0 else 'DOWN'
           shares = up_shares if up_shares > 0 else down_shares
           window_state['capture_entry'] = {'side': side, 'shares': shares}
   ```

3. Update the status line to show position info:
   ```python
   pos_str = f"UP:{up_shares:.1f} DN:{down_shares:.1f}" if (up_shares or down_shares) else "no pos"
   print(f"[{datetime.now(PST).strftime('%H:%M:%S')}] T-{remaining_secs:3d}s | {pos_str} | {slug}")
   ```

4. Initialize `up_token, down_token = None, None` near the top of main() and reset on window change.
  </action>
  <verify>
Run the tracker for a few seconds. Status line should show position info:
`[HH:MM:SS] T-XXXs | UP:0.0 DN:0.0 | btc-updown-15m-XXXXXXXXXX`

Or if no wallet configured:
`[HH:MM:SS] T-XXXs | no pos | btc-updown-15m-XXXXXXXXXX`
  </verify>
  <done>
Main loop polls positions each second and updates window_state. Status line shows current position counts.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. Bot runs without errors
2. Position API is called each second (verify in logs or network)
3. Status line shows UP:X.X DN:X.X format
4. window_state['arb_entry'] or window_state['capture_entry'] populated when positions detected
</verification>

<success_criteria>
- POS-01 COMPLETE: Detects ARB entries (both UP and DOWN positions)
- POS-03 COMPLETE: Detects 99c capture entries (single-side position)
- Bot shows positions in real-time status line
- window_state updated with position data ready for grading in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/02-position-detection/02-01-SUMMARY.md`
</output>
