---
phase: 01-core-bot-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - performance_tracker.py
autonomous: true

must_haves:
  truths:
    - "Bot knows current BTC 15-min window slug"
    - "Bot displays time remaining until window close"
    - "Bot fetches market data from Polymarket API"
  artifacts:
    - path: "performance_tracker.py"
      provides: "Window detection and time remaining"
      exports: ["get_current_slug", "get_market_data", "get_time_remaining"]
  key_links:
    - from: "performance_tracker.py"
      to: "https://gamma-api.polymarket.com"
      via: "HTTP GET"
      pattern: "gamma-api\\.polymarket\\.com/events"
    - from: "main loop"
      to: "get_current_slug"
      via: "function call"
      pattern: "get_current_slug\\(\\)"
---

<objective>
Add window detection and time remaining display to the performance tracker.

Purpose: The bot needs to know which 15-minute window it's observing and how much time remains.
Output: Bot displays current window slug and countdown every second.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-core-bot-infrastructure/01-RESEARCH.md
@.planning/phases/01-core-bot-infrastructure/01-01-SUMMARY.md

# Reference patterns from existing bot
@trading_bot_smart.py (lines 607-633 for window detection patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add window detection functions</name>
  <files>performance_tracker.py</files>
  <action>
Add the three core window detection functions after the HTTP session setup, before signal handler:

1. **get_current_slug()** - Calculate window from Unix timestamp:
   ```python
   def get_current_slug():
       """Calculate current BTC 15-min window slug from Unix timestamp."""
       current = int(time.time())
       window_start = (current // 900) * 900  # 900 seconds = 15 minutes
       return f"btc-updown-15m-{window_start}", window_start
   ```

2. **get_market_data(slug)** - Fetch market metadata from Polymarket:
   ```python
   def get_market_data(slug):
       """Fetch market metadata from Polymarket gamma-api."""
       try:
           url = f"https://gamma-api.polymarket.com/events?slug={slug}"
           resp = http_session.get(url, timeout=3)
           data = resp.json()
           return data[0] if data else None
       except Exception as e:
           print(f"[WARN] Market data fetch failed: {e}")
           return None
   ```

3. **get_time_remaining(market)** - Calculate seconds until window close:
   ```python
   def get_time_remaining(market):
       """Calculate time remaining from market endDate."""
       try:
           end_str = market.get('markets', [{}])[0].get('endDate', '')
           end_time = datetime.fromisoformat(end_str.replace('Z', '+00:00'))
           remaining = (end_time - datetime.now(timezone.utc)).total_seconds()
           if remaining < 0:
               return "ENDED", -1
           return f"{int(remaining)//60:02d}:{int(remaining)%60:02d}", int(remaining)
       except Exception as e:
           print(f"[WARN] Time remaining parse failed: {e}")
           return "??:??", 0
   ```

These are copied from trading_bot_smart.py with minor logging improvements.
  </action>
  <verify>
After adding functions, verify they're syntactically correct:
`python3 -c "import performance_tracker; print(performance_tracker.get_current_slug())"`
Should print something like: ('btc-updown-15m-1737417600', 1737417600)
  </verify>
  <done>
Three window detection functions added and importable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update main loop to display window status</name>
  <files>performance_tracker.py</files>
  <action>
Update the main() function to use window detection:

```python
def main():
    print("Performance Tracker starting main loop...")

    cached_market = None
    last_slug = None

    while True:
        cycle_start = time.time()

        try:
            # Get current window
            slug, window_start = get_current_slug()

            # Detect window change
            if slug != last_slug:
                cached_market = None  # Force refresh on new window
                last_slug = slug
                print(f"\n{'='*50}")
                print(f"NEW WINDOW: {slug}")
                print(f"{'='*50}")

            # Fetch market data (cache per window)
            if not cached_market:
                cached_market = get_market_data(slug)
                if not cached_market:
                    print(f"[{datetime.now(PST).strftime('%H:%M:%S')}] Waiting for market data...")
                    time.sleep(2)
                    continue

            # Calculate time remaining
            time_str, remaining_secs = get_time_remaining(cached_market)

            if remaining_secs < 0:
                print(f"[{datetime.now(PST).strftime('%H:%M:%S')}] Window ended, waiting for next...")
                time.sleep(2)
                continue

            # Display status line
            print(f"[{datetime.now(PST).strftime('%H:%M:%S')}] T-{remaining_secs:3d}s | {slug}")

            # Maintain 1-second loop
            elapsed = time.time() - cycle_start
            time.sleep(max(0, 1 - elapsed))

        except Exception as e:
            print(f"ERROR: {e}")
            import traceback
            traceback.print_exc()
            time.sleep(1)

if __name__ == "__main__":
    main()
```

Key behaviors:
- Caches market data per window (only fetches once per window)
- Detects window transitions with banner
- Shows countdown every second
- Handles API failures gracefully
  </action>
  <verify>
Run: `python3 performance_tracker.py`
- Should show "NEW WINDOW" banner on startup
- Should display `T-XXXs | btc-updown-15m-XXXXX` every second
- Countdown should decrease each second
- When window ends, should detect new window
  </verify>
  <done>
Bot displays current window and countdown in real-time.
  </done>
</task>

</tasks>

<verification>
1. `python3 performance_tracker.py` shows window detection working
2. Status line format: `[HH:MM:SS] T-XXXs | btc-updown-15m-XXXXXXXXXX`
3. Countdown decreases each second
4. "NEW WINDOW" banner appears at window boundaries
5. API failures don't crash the bot
</verification>

<success_criteria>
- Bot correctly identifies current 15-min window
- Time remaining updates every second
- Window transitions detected with banner
- Market data cached per window (1 API call per window, not per second)
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-bot-infrastructure/01-02-SUMMARY.md`
</output>
