---
phase: 03-hedge-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [trading_bot_smart.py]
autonomous: true

must_haves:
  truths:
    - "When danger score >= 0.40 while holding 99c position, hedge order is placed"
    - "Hedge buys opposite side at ask price (market order)"
    - "Hedge only triggers once per position"
    - "Hedge respects 50c limit on opposite side"
    - "Hedge shares match original 99c capture fill shares"
  artifacts:
    - path: "trading_bot_smart.py"
      provides: "check_99c_capture_hedge() with danger score trigger"
      contains: "danger_score >= DANGER_THRESHOLD"
  key_links:
    - from: "check_99c_capture_hedge()"
      to: "window_state['danger_score']"
      via: "dictionary lookup"
      pattern: "window_state.get\\('danger_score'"
    - from: "check_99c_capture_hedge()"
      to: "place_and_verify_order()"
      via: "function call when threshold exceeded"
      pattern: "place_and_verify_order\\(opposite_token"
---

<objective>
Modify check_99c_capture_hedge() to trigger based on danger score instead of confidence threshold

Purpose: Replace the old single-signal confidence threshold (85%) with the new multi-signal danger score (0.40) for hedge triggering, completing the smart hedge system
Output: Modified check_99c_capture_hedge() function that hedges when danger_score >= DANGER_THRESHOLD
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-hedge-execution/03-RESEARCH.md

# Prior phase SUMMARYs - needed because this phase uses danger_score from Phase 2
@.planning/phases/02-danger-scoring-engine/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify trigger condition from confidence to danger score</name>
  <files>trading_bot_smart.py</files>
  <action>
Modify check_99c_capture_hedge() function (around lines 1323-1398) to use danger score instead of confidence threshold.

**Changes required:**

1. **Update function docstring** (line 1324):
   - Change from: `"""Monitor 99c capture position and hedge if confidence drops."""`
   - Change to: `"""Monitor 99c capture position and hedge if danger score exceeds threshold."""`

2. **Remove old confidence calculation** (lines 1354-1355):
   - Delete or comment out: `new_confidence, time_penalty = calculate_99c_confidence(current_ask, ttc)`

3. **Replace trigger condition** (line 1358):
   - Change from: `if new_confidence < CAPTURE_99C_HEDGE_THRESHOLD:`
   - Change to: `danger_score = window_state.get('danger_score', 0)` followed by `if danger_score >= DANGER_THRESHOLD:`

4. **Update banner message** (lines 1364-1368):
   - Change the "Confidence dropped" line to show danger score instead:
     ```python
     print(f"│  Danger score: {danger_score:.2f} >= {DANGER_THRESHOLD:.2f} threshold".ljust(50) + "│")
     print(f"│  Bet: {bet_side} @ 99c".ljust(50) + "│")
     print(f"│  Hedging: {shares} {opposite_side} @ {opposite_ask*100:.0f}c".ljust(50) + "│")
     ```
   - Remove the line showing current ask price (was only relevant for confidence tracking)

**Keep unchanged:**
- All guards (HEDGE_ENABLED, fill_notified, not_hedged) - HEDGE-03
- Opposite side lookup and token retrieval
- shares from window_state.get('capture_99c_shares', 0) - HEDGE-05
- opposite_ask < 0.50 check - HEDGE-04
- place_and_verify_order() call - HEDGE-02
- All post-hedge logic (combined cost calc, state updates, sheets_log_event)

**Note:** The `current_ask` variable for our bet side is no longer needed for trigger decision but may still be calculated. You can leave the lookup code but remove the early return if current_ask == 0 since danger_score handles missing data with defaults.
  </action>
  <verify>
grep "danger_score >= DANGER_THRESHOLD" trading_bot_smart.py
# Expected: 1 match in check_99c_capture_hedge function

grep "window_state.get('danger_score'" trading_bot_smart.py
# Expected: At least 1 match showing danger_score retrieval
  </verify>
  <done>
check_99c_capture_hedge() triggers based on danger_score >= 0.40 instead of confidence < 85%
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sheets logging with danger score and commit</name>
  <files>trading_bot_smart.py</files>
  <action>
Update the sheets_log_event call for 99C_HEDGE to include the danger_score value:

1. **Update sheets_log_event call** (around line 1392-1394):
   - Add danger_score parameter to the existing call:
     ```python
     sheets_log_event("99C_HEDGE", window_state.get('window_id', ''),
                    bet_side=bet_side, hedge_side=opposite_side,
                    hedge_price=opposite_ask, combined=combined, loss=total_loss,
                    danger_score=danger_score)
     ```

2. **Update version** at top of file:
   - Increment version: v1.2 -> v1.3
   - New codename: Pick two words [Adjective] [Noun/Animal]
   - Update date to 2026-01-19
   - Changes: "Hedge trigger now uses multi-signal danger score instead of confidence"

3. **Commit the changes:**
   - Stage trading_bot_smart.py
   - Commit with message: `feat(03-01): replace confidence hedge trigger with danger score`
  </action>
  <verify>
grep "danger_score=danger_score" trading_bot_smart.py
# Expected: 1 match in sheets_log_event call

head -10 trading_bot_smart.py | grep "v1.3"
# Expected: Version shows v1.3

git log --oneline -1
# Expected: Shows feat(03-01) commit
  </verify>
  <done>
Sheets logging includes danger_score, version bumped to v1.3, changes committed
  </done>
</task>

</tasks>

<verification>
**Functional verification (all requirements):**

```bash
# HEDGE-01: Trigger condition uses danger score
grep -A2 "def check_99c_capture_hedge" trading_bot_smart.py | head -5
grep "danger_score >= DANGER_THRESHOLD" trading_bot_smart.py

# HEDGE-02: Still uses place_and_verify_order at ask price
grep "place_and_verify_order.*opposite_token.*opposite_ask" trading_bot_smart.py

# HEDGE-03: Guard for already hedged still present
grep "capture_99c_hedged" trading_bot_smart.py | head -3

# HEDGE-04: Price limit still present
grep "opposite_ask < 0.50" trading_bot_smart.py

# HEDGE-05: Shares from window_state
grep "capture_99c_shares" trading_bot_smart.py | head -2

# Syntax check
python3 -m py_compile trading_bot_smart.py && echo "Syntax OK"
```
</verification>

<success_criteria>
1. check_99c_capture_hedge() uses `danger_score >= DANGER_THRESHOLD` as trigger condition
2. Old confidence-based trigger (`new_confidence < CAPTURE_99C_HEDGE_THRESHOLD`) removed from hedge check
3. Banner displays danger score (not confidence) when hedge triggers
4. All existing guards maintained (HEDGE-03, HEDGE-04)
5. Shares from window_state unchanged (HEDGE-05)
6. Order execution via place_and_verify_order unchanged (HEDGE-02)
7. Version bumped to v1.3
8. Code compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-hedge-execution/03-01-SUMMARY.md`
</output>
